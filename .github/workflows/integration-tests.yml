name: Integration Tests

on:
  # Manual trigger only â€” these are optional post-deployment checks
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to test'
        required: true
        default: 'prod'
        type: choice
        options:
          - dev
          - staging
          - prod
      api_url:
        description: 'Backend API URL to test'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

env:
  PYTHON_VERSION: '3.12'

jobs:
  api-smoke-tests:
    name: API Smoke Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install test dependencies
        run: pip install requests

      - name: Run API smoke tests
        env:
          API_URL: ${{ inputs.api_url }}
          TEST_ENV: ${{ inputs.environment }}
        run: |
          python - << 'EOF'
          import requests, sys, os

          API_URL = os.environ["API_URL"].rstrip("/")
          passed, failed = 0, 0

          def check(name, fn):
              global passed, failed
              try:
                  fn()
                  print(f"  âœ… {name}")
                  passed += 1
              except Exception as e:
                  print(f"  âŒ {name}: {e}")
                  failed += 1

          print(f"\nðŸ” Testing API at {API_URL}\n")

          # 1. Docs endpoint
          check("API docs accessible", lambda: (
              r := requests.get(f"{API_URL}/docs", timeout=15),
              assert r.status_code == 200
          ))

          # 2. OpenAPI schema
          check("OpenAPI schema valid", lambda: (
              r := requests.get(f"{API_URL}/openapi.json", timeout=15),
              assert r.status_code == 200,
              assert "openapi" in r.json()
          ))

          # 3. Auth endpoint exists
          check("Auth login endpoint exists", lambda: (
              r := requests.post(f"{API_URL}/api/v1/auth/login", json={}, timeout=15),
              assert r.status_code != 404
          ))

          # 4. Protected endpoint returns 401
          check("Protected endpoints require auth", lambda: (
              r := requests.get(f"{API_URL}/api/v1/customers/", timeout=15),
              assert r.status_code == 401
          ))

          # 5. Response format
          check("API returns JSON", lambda: (
              r := requests.post(f"{API_URL}/api/v1/auth/login", json={"email": "x", "password": "x"}, timeout=15),
              assert "json" in r.headers.get("content-type", "").lower()
          ))

          print(f"\n{'='*40}")
          print(f"Results: {passed} passed, {failed} failed")

          if failed > 0:
              sys.exit(1)
          EOF

      - name: Report results
        if: always()
        env:
          TEST_ENV: ${{ inputs.environment }}
          API_URL: ${{ inputs.api_url }}
        run: |
          echo "## ðŸ” API Smoke Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** $TEST_ENV" >> $GITHUB_STEP_SUMMARY
          echo "**API URL:** $API_URL" >> $GITHUB_STEP_SUMMARY
